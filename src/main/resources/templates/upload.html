<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="https://www.thymeleaf.org"
      xmlns:sec="https://www.thymeleaf.org/thymeleaf-extras-springsecurity3" lang="en">

<head>
    <title>CubeTrek</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-0evHe/X+R7YkIZDRvuzKMRqM+OrBnVFBL6DOitfPri4tjfHxaWutUpFmBp4vmVor" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-pprn3073KE6tl6bjs2QrFaJGz5/SUsLqktiwsUTF55Jfv3qYSDhgCecCxMW52nD2"
            crossorigin="anonymous"></script>
    <link href="../css/dashboard.css" rel="stylesheet">
    <style>
        .drop-area {
            border: 2px dashed #ccc;
            border-radius: 20px;
            width: 480px;
            padding: 5px;
        }
        .dragging {
            border: 4px #000000;
        }

        #drop_zone * {pointer-events: none;}
    </style>
</head>
<body>
<header th:replace="dashboard.html :: header">
</header>

<div class="container-fluid">
    <div class="row">
        <nav th:replace="dashboard.html :: navigation(field='upload')" id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse">
        </nav>

        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                <h1 class="h2" th:text="'Upload for ' + ${user.getName()}" >Upload</h1>
            </div>

                <div id="drop_zone" class="drop-area">
                    <input type="file" id="uploadfile" multiple>
                    <p>Click or drag files. Accepted file types: GPX and FIT.</p>
                </div>



            <table class="table" id="table" style="display: none;">
               <thead><tr>
                   <th>File name</th>
                   <th>Track Name</th>
                   <th>Type</th>
                   <th>Date</th>
                   <th>Distance</th>
                   <th>Elevation Gain</th>
                   <th>Time</th>
                   <th> </th>
               </tr></thead>
                <tbody>
                </tbody>
            </table>


        </main>
    </div>
</div>
<script>
    const inputElement = document.getElementById("uploadfile");
    const dropbox = document.getElementById("drop_zone");
    const table = document.getElementById("table");

    inputElement.addEventListener("change", changeFiles, false);
    dropbox.addEventListener("dragenter", dragenter, false);
    dropbox.addEventListener("dragleave", dragleave, false);
    dropbox.addEventListener("dragover", dragover, false);
    dropbox.addEventListener("drop", drop, false);
    dropbox.addEventListener("click", clickdropbox, false);

    function changeFiles() {
        handleFiles(this.files)
    }
    function handleFiles(fileList) {

        for (let i = 0, numFiles = fileList.length; i < numFiles; i++) {
            const file = fileList[i];
            sendFile(file);
        }
    }

    var tableStore = {key1: "empty"};
    var concurrentuploads = 0;

    function sendFile(file) {
        table.style.display = 'block';
        const uri = "/upload";
        const xhr = new XMLHttpRequest();
        const fd = new FormData();

        tableStore[file.name+file.lastModified] = table.insertRow(-1);
        tableStore[file.name+file.lastModified].insertCell(0).appendChild(document.createTextNode(file.name));
        tableStore[file.name+file.lastModified].insertCell(1).innerHTML = "<div class=\"progress\"><div class=\"progress-bar progress-bar-striped progress-bar-animated\" role=\"progressbar\" style=\"width: 0%\" id='progress"+file.name+file.lastModified+"'></div></div>";
        tableStore[file.name+file.lastModified].insertCell(2).innerHTML = "<div class=\"spinner-border spinner-border-sm text-info\" role=\"status\" />";


        xhr.open("POST", uri, true);
        xhr.upload.onprogress = function(evt)
        {
            var percentComplete = evt.loaded / file.size * 100;
            document.getElementById("progress"+file.name+file.lastModified).setAttribute("style","width: "+percentComplete+"%");
        };
        xhr.onreadystatechange = function() {
            if (xhr.readyState === 4 && xhr.status === 200) {
                tableStore[file.name+file.lastModified].deleteCell(2);
                tableStore[file.name+file.lastModified].deleteCell(1);
                var responsejson = JSON.parse(xhr.responseText);
                tableStore[file.name+file.lastModified].insertCell(1).innerHTML = responsejson.title;
                tableStore[file.name+file.lastModified].insertCell(2).innerHTML = responsejson.activitytype;
                tableStore[file.name+file.lastModified].insertCell(3).innerHTML = responsejson.date;
                tableStore[file.name+file.lastModified].insertCell(4).innerHTML = (parseFloat(responsejson.trackSummary.distance)/1000).toFixed(1) + " km";
                tableStore[file.name+file.lastModified].insertCell(5).innerHTML = responsejson.trackSummary.elevationUp + " m";
                tableStore[file.name+file.lastModified].insertCell(6).innerHTML = minToString(parseInt(responsejson.trackSummary.duration))+ " h";
                tableStore[file.name+file.lastModified].insertCell(7).innerHTML = "<a href='view/"+responsejson.trackID+"' target='_blank'>View</a>";
            }
            else if (xhr.readyState === 4 && xhr.status === 400) {
                tableStore[file.name+file.lastModified].deleteCell(2);
                tableStore[file.name+file.lastModified].deleteCell(1);
                var responsejson = JSON.parse(xhr.responseText);
                tableStore[file.name+file.lastModified].insertCell(1).innerHTML = "<span class=\"badge bg-warning text-dark\">Error</span>";
                tableStore[file.name+file.lastModified].insertCell(2).innerHTML = responsejson.response;
            } else if (xhr.readyState === 4 && xhr.status === 0) {
                tableStore[file.name+file.lastModified].deleteCell(2);
                tableStore[file.name+file.lastModified].deleteCell(1);
                tableStore[file.name+file.lastModified].insertCell(1).innerHTML = "<span class=\"badge bg-warning text-dark\">Error</span>";
                tableStore[file.name+file.lastModified].insertCell(2).innerHTML = "No response from server";
            } else if (xhr.readyState === 4) {
                tableStore[file.name+file.lastModified].deleteCell(2);
                tableStore[file.name+file.lastModified].deleteCell(1);
                tableStore[file.name+file.lastModified].insertCell(1).innerHTML = "<span class=\"badge bg-warning text-dark\">Error</span>";
                tableStore[file.name+file.lastModified].insertCell(2).innerHTML = "Error "+xhr.status;
            }
        };
        fd.append('file', file);
        // Initiate a multipart/form-data upload
        concurrentuploads++;
        setTimeout(function() {
            xhr.send(fd);
        }, Math.max(concurrentuploads-5,0)*10); //TODO: longer timeouts for production
    }

    function minToString(minutes) {
        var m = minutes % 60;
        var h = (minutes-m)/60;
        return h.toString() + ":" + (m<10?"0":"") + m.toString();
    }

    function dragenter(e) {
        e.stopPropagation();
        e.preventDefault();
        dropbox.classList.add('dragging');
    }

    function dragleave(e) {
        e.stopPropagation();
        e.preventDefault();
        dropbox.classList.remove('dragging');
    }

    function dragover(e) {
        e.stopPropagation();
        e.preventDefault();
    }

    function drop(e) {
        e.stopPropagation();
        e.preventDefault();

        const dt = e.dataTransfer;
        const files = dt.files;
        handleFiles(files);
    }

    function clickdropbox(e) {
        inputElement.click();
    }



</script>

</body>
</html>